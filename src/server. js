import express from 'express';
import dotenv from 'dotenv';
import cors from 'cors'; // Import the CORS middleware
import connectDB from './config/db.js';

// Import all necessary files and middleware
import { notFound, errorHandler } from './middleware/errorMiddleware.js';

// Import routes
import userRoutes from './routes/userRoutes.js';
import vendorRoutes from './routes/vendorRoutes.js';
import productRoutes from './routes/productRoutes.js';
import orderRoutes from './routes/orderRoutes.js';

// Configuration
dotenv.config();
connectDB(); // Assuming this is your MongoDB connection function

const app = express();

// --- CORS Configuration ---
// Define the allowed origins (your frontend URL and localhost for testing)
const allowedOrigins = [
    // Your deployed frontend URL
    'https://multi-vendor-frontend-user.onrender.com', 
    // Local development URL
    'http://localhost:5173' 
];

// Apply the CORS middleware
app.use(cors({
    origin: function (origin, callback) {
        // Allow requests with no origin (like mobile apps, curl)
        if (!origin) return callback(null, true);
        
        // Check if the requesting origin is in our allowed list
        if (allowedOrigins.indexOf(origin) === -1) {
            const msg = 'The CORS policy for this site does not allow access from the specified Origin.';
            return callback(new Error(msg), false);
        }
        return callback(null, true);
    },
    methods: 'GET,HEAD,PUT,PATCH,POST,DELETE',
    credentials: true,
}));
// --- End CORS Configuration ---


// Middleware
app.use(express.json());


// Routes
// Note: Removed the redundant /api prefix from the app.use() lines, 
// as it appears in the route files themselves based on your old code structures. 
// If your route files don't already include the /api/v1 prefix, you may need to re-add it here.
app.use('/api/v1/users', userRoutes);
app.use('/api/v1/vendors', vendorRoutes);
app.use('/api/v1/products', productRoutes);
app.use('/api/v1/orders', orderRoutes);

app.get('/', (req, res) => {
    res.send('Multi-vendor backend running!');
});

// Error Middleware (must be after routes)
app.use(notFound);
app.use(errorHandler);


const PORT = process.env.PORT || 5000;

app.listen(PORT, () =>
    console.log(`Server running in ${process.env.NODE_ENV} mode on port ${PORT}`)
);
